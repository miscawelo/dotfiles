- name: Install base packages
  apk:
    name:
    - nextcloud-mysql
    - mariadb
    - mariadb-client
    - nextcloud-initscript
    - py3-mysqlclient
    - nginx
    - php81-fpm

- name: Initialize MariaDB
  command: mysql_install_db --user=mysql --datadir=/var/lib/mysql

- name: Enable and start MariaDB service
  service:
    name: mariadb
    state: started
    enabled: yes

- name: Enable and start MariaDB service
  service:
    name: nginx
    state: started
    enabled: yes

- name: Enable and start MariaDB service
  service:
    name: nextcloud
    state: started
    enabled: yes

- name: Block
  block:
    - name: Secures the MySQL root user for localhost domain (localhost)
      mysql_user:
        user: root
        password: '{{ rootUserPass }}'
        host: localhost

    - name: Delete anonymous user
      mysql_user:
        user: ''
        state: absent

    - name: Remove the MySQL test database
      mysql_db:
        db: test
        state: absent

    - name: Create the Nextcloud
      mysql_db:
        name: nextcloud
        state: present

    - name: Create user with password, all database privileges and 'WITH GRANT OPTION' in db1 and db2
      mysql_user:
        name: admin
        host: localhost
        password: '{{ mysqlPass }}'
        priv: 'nextcloud.*:ALL,GRANT'
        state: present

    - name: Create user with password, all database privileges and 'WITH GRANT OPTION' in db1 and db2
      mysql_user:
        name: admin
        host: localhost.localdomain
        password: '{{ mysqlPass }}'
        priv: 'nextcloud.*:ALL,GRANT'
        state: present

    - name: Refrescar los privilegios
      community.mysql.mysql_user:
        priv: '*.*:RELOAD'
        append_privs: yes
        state: present

  rescue:
    - name: Secures the MySQL root user for localhost domain (localhost)
      mysql_user:
        user: root
        password: '{{ rootUserPass }}'
        host: localhost
        login_user: root
        login_password: '{{ rootUserPass }}'

    - name: Delete anonymous user
      mysql_user:
        user: ''
        state: absent
        login_user: root
        login_password: '{{ rootUserPass }}'

    - name: Remove the MySQL test database
      mysql_db:
        db: test
        login_user: root
        login_password: '{{ rootUserPass }}'
        state: absent

    - name: Create the Nextcloud
      mysql_db:
        name: nextcloud
        login_user: root
        login_password: '{{ rootUserPass }}'
        state: present

    - name: Create user with password, all database privileges and 'WITH GRANT OPTION' in db1 and db2
      mysql_user:
        name: admin
        host: localhost
        password: '{{ mysqlPass }}'
        priv: 'nextcloud.*:ALL,GRANT'
        login_user: root
        login_password: '{{ rootUserPass }}'
        state: present

    - name: Create user with password, all database privileges and 'WITH GRANT OPTION' in db1 and db2
      mysql_user:
        name: admin
        host: localhost.localdomain
        password: '{{ mysqlPass }}'
        priv: 'nextcloud.*:ALL,GRANT'
        login_user: root
        login_password: '{{ rootUserPass }}'
        state: present

    - name: Refrescar los privilegios
      mysql_user:
        user: admin
        priv: '*.*:RELOAD'
        append_privs: yes
        login_user: root
        login_password: '{{ rootUserPass }}'
        state: present

- name: Delete default Nginx website
  file:
    path: /etc/nginx/http.d/default.conf
    state: absent

- name: Copy Nginx config file
  copy:
    src: roles/nextcloud/files/config_nginx_nextcloud.conf
    dest: /etc/nginx/http.d/nextcloud.conf

- name: Ensure SELinux is set to enforcing mode
  lineinfile:
    path: /etc/nginx/nginx.conf
    regexp: 'client_max_body_size'
    line: client_max_body_size 16G;

- name: Ensure SELinux is set to enforcing mode
  lineinfile:
    path: /etc/php81/php.ini
    regexp: 'upload_max_filesize'
    line: upload_max_filesize = 16G

- name: Copy Nginx config file
  copy:
    src: roles/nextcloud/files/config_php_nextcloud.conf
    dest: /etc/php81/php-fpm.d/nextcloud.conf
- name: Insert/Update HTML surrounded by custom markers after <body> line
  blockinfile:
    path: /etc/nextcloud/config.php
    marker: '# MANAGED BY ANSIBLE {mark}'
    insertafter: "0 => '{{ ansible_eth0.ipv4.address }}',"
    block:
      "    1 => 'nextcloud.miscawelo-nas.com',"

- name: Enable and start MariaDB service
  service:
    name: nginx
    state: restarted

- name: Enable and start MariaDB service
  service:
    name: nextcloud
    state: restarted
