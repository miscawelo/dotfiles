- name: Install base packages
  apt:
    name:
      - sqlite3

- name: Add groups
  group:
    name: '{{ item }}'
    state: present
  with_items:
    - sonarr
    - media

- name: Add 'sonarr' user
  user:
    name: sonarr
    groups:
      - sonarr
      - media

- name: Create Sonarr config directory
  file:
    path: /var/lib/sonarr
    state: directory
    owner: sonarr
    group: media
    mode: '0775'

- name: Download latest Sonarr version
  unarchive:
    src: 'https://services.sonarr.tv/v1/download/main/latest?version=4&os=linux&arch=x64'
    dest: /opt
    owner: sonarr
    group: media
    mode: '0775'
    remote_src: yes

- name: Copy Sonarr service file
  copy:
    src: roles/sonarr/files/service_sonarr
    dest: /etc/systemd/system/sonarr.service
    mode: '0644'

- name: Reload systemd daemons
  service:
    daemon_reload: true
    name: 'sonarr.service'
    state: started
    enabled: yes
